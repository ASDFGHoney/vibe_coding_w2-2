name: Issue Auto Assigner

on:
  issues:
    types: [opened, labeled]

jobs:
  auto-assign-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
    - name: Auto assign issue
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          const title = issue.title.toLowerCase();
          const body = (issue.body || '').toLowerCase();
          const labels = issue.labels.map(label => label.name);
          
          // íŒ€ ë©¤ë²„ ì •ì˜ (ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
          const teamMembers = {
            'team-leader': ['management', 'strategy', 'general'],
            'backend-lead': ['backend', 'api', 'database', 'server'],
            'frontend-lead': ['frontend', 'ui', 'ux', 'design'],
            'devops-lead': ['deployment', 'ci/cd', 'infrastructure', 'docker'],
            'qa-lead': ['testing', 'quality', 'bug', 'validation'],
            'security-lead': ['security', 'auth', 'permission', 'vulnerability']
          };
          
          // ì´ìŠˆ íƒ€ì…ë³„ ê¸°ë³¸ ë‹´ë‹¹ì
          const typeAssignments = {
            'bug': 'qa-lead',
            'feature': 'team-leader',
            'enhancement': 'team-leader',
            'question': 'team-leader',
            'documentation': 'team-leader',
            'security': 'security-lead',
            'performance': 'backend-lead'
          };
          
          let assignees = [];
          
          try {
            // 1. ë¼ë²¨ ê¸°ë°˜ í• ë‹¹
            for (const label of labels) {
              if (typeAssignments[label]) {
                assignees.push(typeAssignments[label]);
              }
            }
            
            // 2. ì œëª©/ë‚´ìš© í‚¤ì›Œë“œ ê¸°ë°˜ í• ë‹¹
            const allText = title + ' ' + body;
            
            for (const [member, keywords] of Object.entries(teamMembers)) {
              for (const keyword of keywords) {
                if (allText.includes(keyword)) {
                  assignees.push(member);
                  break;
                }
              }
            }
            
            // 3. ì´ìŠˆ ì œëª© íŒ¨í„´ ê¸°ë°˜ í• ë‹¹
            if (title.includes('[backend]') || title.includes('api') || title.includes('server')) {
              assignees.push('backend-lead');
            }
            if (title.includes('[frontend]') || title.includes('ui') || title.includes('client')) {
              assignees.push('frontend-lead');
            }
            if (title.includes('[devops]') || title.includes('deploy') || title.includes('infrastructure')) {
              assignees.push('devops-lead');
            }
            if (title.includes('[security]') || title.includes('auth') || title.includes('permission')) {
              assignees.push('security-lead');
            }
            
            // 4. ê¸´ê¸‰ë„ ê¸°ë°˜ ì¶”ê°€ í• ë‹¹
            if (labels.includes('urgent') || labels.includes('critical') || title.includes('urgent')) {
              assignees.push('team-leader');
            }
            
            // ì¤‘ë³µ ì œê±° ë° ê¸°ë³¸ê°’ ì„¤ì •
            assignees = [...new Set(assignees)];
            
            // ì•„ë¬´ë„ í• ë‹¹ë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ í• ë‹¹
            if (assignees.length === 0) {
              assignees = ['team-leader'];
            }
            
            // ìµœëŒ€ 2ëª…ê¹Œì§€ë§Œ í• ë‹¹ (ë„ˆë¬´ ë§ì€ í• ë‹¹ ë°©ì§€)
            assignees = assignees.slice(0, 2);
            
            // í• ë‹¹ ì‹¤í–‰
            if (assignees.length > 0) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: assignees
              });
              
              console.log(`Assigned issue to: ${assignees.join(', ')}`);
              
              // í• ë‹¹ ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
              const assignmentReason = [];
              
              // í• ë‹¹ ì´ìœ  ë¶„ì„
              if (labels.some(label => typeAssignments[label])) {
                assignmentReason.push('ë¼ë²¨ ê¸°ë°˜ ìë™ í• ë‹¹');
              }
              if (assignees.includes('team-leader') && (labels.includes('urgent') || title.includes('urgent'))) {
                assignmentReason.push('ê¸´ê¸‰ ì´ìŠˆë¡œ íŒ€ ë¦¬ë” í• ë‹¹');
              }
              
              const keywords = [];
              for (const [member, memberKeywords] of Object.entries(teamMembers)) {
                if (assignees.includes(member)) {
                  const foundKeywords = memberKeywords.filter(keyword => 
                    (title + ' ' + body).includes(keyword)
                  );
                  if (foundKeywords.length > 0) {
                    keywords.push(`${member}: ${foundKeywords.join(', ')}`);
                  }
                }
              }
              
              if (keywords.length > 0) {
                assignmentReason.push('í‚¤ì›Œë“œ ë§¤ì¹­');
              }
              
              const assignmentComment = `## ğŸ‘¥ ìë™ í• ë‹¹ ì™„ë£Œ

              **í• ë‹¹ëœ ë‹´ë‹¹ì:**
              ${assignees.map(assignee => `- @${assignee}`).join('\n')}

              **í• ë‹¹ ê¸°ì¤€:**
              ${assignmentReason.length > 0 ? assignmentReason.map(reason => `- ${reason}`).join('\n') : '- ê¸°ë³¸ í• ë‹¹ ê·œì¹™ ì ìš©'}

              ${keywords.length > 0 ? `\n**ë§¤ì¹­ëœ í‚¤ì›Œë“œ:**\n${keywords.map(kw => `- ${kw}`).join('\n')}` : ''}

              **ğŸ“ ë‹´ë‹¹ìë³„ ì—­í• :**
              - **team-leader**: ì „ì²´ ì´ìŠˆ ê´€ë¦¬ ë° ìš°ì„ ìˆœìœ„ ê²°ì •
              - **backend-lead**: ë°±ì—”ë“œ ê´€ë ¨ ê¸°ìˆ  ì´ìŠˆ
              - **frontend-lead**: í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨ ê¸°ìˆ  ì´ìŠˆ
              - **devops-lead**: ì¸í”„ë¼ ë° ë°°í¬ ê´€ë ¨ ì´ìŠˆ
              - **qa-lead**: í’ˆì§ˆ ê´€ë¦¬ ë° í…ŒìŠ¤íŠ¸ ê´€ë ¨ ì´ìŠˆ
              - **security-lead**: ë³´ì•ˆ ê´€ë ¨ ì´ìŠˆ

              **â° ë‹¤ìŒ ë‹¨ê³„:**
              1. ë‹´ë‹¹ìê°€ ì´ìŠˆ ë‚´ìš©ì„ ê²€í† í•©ë‹ˆë‹¤
              2. í•„ìš”ì‹œ ì¶”ê°€ ì •ë³´ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
              3. ì‘ì—… ì¼ì •ì„ ìˆ˜ë¦½í•˜ê³  ì•Œë ¤ë“œë¦½ë‹ˆë‹¤

              ---
              *ì´ í• ë‹¹ì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.*`;
              
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: assignmentComment
              });
            }
            
          } catch (error) {
            console.error('Error in auto-assignment:', error);
            
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ í• ë‹¹
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: ['team-leader']
              });
              
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## âš ï¸ ìë™ í• ë‹¹ ì˜¤ë¥˜

                ìë™ í• ë‹¹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ íŒ€ ë¦¬ë”ì—ê²Œ ê¸°ë³¸ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.

                **ì˜¤ë¥˜ ì •ë³´:** ${error.message}

                íŒ€ ë¦¬ë”ê°€ ì ì ˆí•œ ë‹´ë‹¹ìë¥¼ ì¬í• ë‹¹í•  ì˜ˆì •ì…ë‹ˆë‹¤.

                ---
                *ì˜¤ë¥˜ ë°œìƒìœ¼ë¡œ ì¸í•œ ê¸°ë³¸ í• ë‹¹ì…ë‹ˆë‹¤.*`
              });
              
            } catch (fallbackError) {
              console.error('Fallback assignment also failed:', fallbackError);
            }
          } 