name: PR Auto Labeler

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  label-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Auto label PR
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const title = pr.title.toLowerCase();
          const body = (pr.body || '').toLowerCase();
          
          let labels = [];
          
          try {
            // PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const changedFiles = files.data;
            const filePaths = changedFiles.map(file => file.filename);
            const additions = changedFiles.reduce((sum, file) => sum + file.additions, 0);
            const deletions = changedFiles.reduce((sum, file) => sum + file.deletions, 0);
            
            // 1. ì œëª© ê¸°ë°˜ ë¼ë²¨ë§
            if (title.includes('[feat]') || title.includes('feature') || title.includes('add')) {
              labels.push('feature');
            }
            if (title.includes('[fix]') || title.includes('bug') || title.includes('fix')) {
              labels.push('bugfix');
            }
            if (title.includes('[docs]') || title.includes('documentation') || title.includes('readme')) {
              labels.push('documentation');
            }
            if (title.includes('[refactor]') || title.includes('refactor') || title.includes('cleanup')) {
              labels.push('refactoring');
            }
            if (title.includes('[test]') || title.includes('test')) {
              labels.push('testing');
            }
            if (title.includes('enhancement') || title.includes('improve')) {
              labels.push('enhancement');
            }
            if (title.includes('urgent') || title.includes('hotfix') || title.includes('critical')) {
              labels.push('urgent');
            }
            
            // 2. íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ ë¼ë²¨ë§
            const backendFiles = filePaths.filter(path => path.startsWith('backend/'));
            const frontendFiles = filePaths.filter(path => path.startsWith('frontend/'));
            const testFiles = filePaths.filter(path => path.includes('test') || path.includes('spec'));
            const docFiles = filePaths.filter(path => path.endsWith('.md') || path.startsWith('docs/'));
            const configFiles = filePaths.filter(path => 
              path.includes('config') || 
              path.includes('.yml') || 
              path.includes('.yaml') || 
              path.includes('.json') || 
              path.includes('requirements.txt') ||
              path.includes('.github/')
            );
            
            if (backendFiles.length > 0) labels.push('backend');
            if (frontendFiles.length > 0) labels.push('frontend');
            if (testFiles.length > 0) labels.push('testing');
            if (docFiles.length > 0) labels.push('documentation');
            if (configFiles.length > 0) labels.push('configuration');
            
            // 3. ë³€ê²½ ê·œëª¨ ê¸°ë°˜ ë¼ë²¨ë§
            const totalChanges = additions + deletions;
            if (totalChanges > 500) {
              labels.push('major-change');
            } else if (totalChanges > 100) {
              labels.push('medium-change');
            } else {
              labels.push('minor-change');
            }
            
            // 4. íŠ¹ë³„í•œ íŒŒì¼ ë³€ê²½ ê°ì§€
            const hasPackageChanges = filePaths.some(path => 
              path.includes('requirements.txt') || 
              path.includes('package.json') || 
              path.includes('Pipfile')
            );
            if (hasPackageChanges) labels.push('dependencies');
            
            const hasDbChanges = filePaths.some(path => 
              path.includes('migration') || 
              path.includes('schema') || 
              path.includes('.sql')
            );
            if (hasDbChanges) labels.push('database');
            
            const hasSecurityChanges = filePaths.some(path => 
              path.includes('auth') || 
              path.includes('security') || 
              path.includes('permission')
            );
            if (hasSecurityChanges) labels.push('security');
            
            // 5. PR ë³¸ë¬¸ ê¸°ë°˜ ë¼ë²¨ë§
            if (body.includes('breaking change') || body.includes('breaking-change')) {
              labels.push('breaking-change');
            }
            if (body.includes('wip') || body.includes('work in progress') || pr.draft) {
              labels.push('work-in-progress');
            }
            if (body.includes('needs review') || body.includes('ready for review')) {
              labels.push('ready-for-review');
            }
            
            // ì¤‘ë³µ ì œê±°
            labels = [...new Set(labels)];
            
            // ë¼ë²¨ ì ìš©
            if (labels.length > 0) {
              await github.rest.issues.setLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: labels
              });
              
              console.log(`Applied labels: ${labels.join(', ')}`);
              
              // ë¼ë²¨ë§ ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
              const labelComment = `## ğŸ·ï¸ ìë™ ë¼ë²¨ë§ ì™„ë£Œ

              **ì ìš©ëœ ë¼ë²¨:**
              ${labels.map(label => `- \`${label}\``).join('\n')}

              **ë¼ë²¨ë§ ê¸°ì¤€:**
              - PR ì œëª© ë° ë‚´ìš© ë¶„ì„
              - ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œ ë¶„ì„
              - ì½”ë“œ ë³€ê²½ ê·œëª¨ ë¶„ì„
              - íŠ¹ë³„í•œ íŒŒì¼ ë³€ê²½ì‚¬í•­ ê°ì§€

              **ğŸ“Š ë³€ê²½ í†µê³„:**
              - ë³€ê²½ëœ íŒŒì¼: ${filePaths.length}ê°œ
              - ì¶”ê°€ëœ ì¤„: +${additions}
              - ì‚­ì œëœ ì¤„: -${deletions}

              ---
              *ì´ ë¼ë²¨ë§ì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.*`;
              
              await github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: labelComment
              });
            }
            
          } catch (error) {
            console.error('Error in auto-labeling:', error);
            
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë¼ë²¨ ì ìš©
            const fallbackLabels = ['needs-review'];
            await github.rest.issues.setLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: fallbackLabels
            });
          } 