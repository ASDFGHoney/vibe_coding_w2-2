name: PR Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort bandit pylint
    
    - name: Automated Code Review
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          
          try {
            // PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const pythonFiles = files.data.filter(file => 
              file.filename.endsWith('.py') && file.status !== 'removed'
            );
            
            if (pythonFiles.length === 0) {
              console.log('No Python files to review');
              return;
            }
            
            let reviewComments = [];
            let codeQualityScore = 100;
            let securityIssues = [];
            let styleIssues = [];
            
            // ê° Python íŒŒì¼ì— ëŒ€í•œ ë¶„ì„
            for (const file of pythonFiles) {
              const filename = file.filename;
              const additions = file.additions;
              const deletions = file.deletions;
              const changes = file.changes;
              
              // íŒŒì¼ í¬ê¸° ì²´í¬
              if (changes > 300) {
                reviewComments.push(`âš ï¸ **${filename}**: íŒŒì¼ ë³€ê²½ëŸ‰ì´ í½ë‹ˆë‹¤ (${changes}ì¤„). ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í• ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`);
                codeQualityScore -= 5;
              }
              
              // íŒŒì¼ëª… ì»¨ë²¤ì…˜ ì²´í¬
              if (!filename.match(/^[a-z_][a-z0-9_]*\.py$/)) {
                reviewComments.push(`ğŸ”¤ **${filename}**: íŒŒì¼ëª…ì´ Python ë„¤ì´ë° ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                codeQualityScore -= 3;
              }
              
              // í…ŒìŠ¤íŠ¸ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ì²´í¬
              if (!filename.includes('test_') && filename.startsWith('backend/app/')) {
                const testFileName = filename.replace('backend/app/', 'backend/tests/test_');
                const hasTest = files.data.some(f => f.filename === testFileName);
                if (!hasTest) {
                  reviewComments.push(`ğŸ§ª **${filename}**: í•´ë‹¹í•˜ëŠ” í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. \`${testFileName}\` ìƒì„±ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`);
                  codeQualityScore -= 10;
                }
              }
            }
            
            // PR ì œëª© ë° ì„¤ëª… í’ˆì§ˆ ì²´í¬
            if (!pr.title.match(/^\[(feat|fix|docs|style|refactor|test|chore)\]/)) {
              reviewComments.push(`ğŸ“ **PR ì œëª©**: ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. \`[íƒ€ì…] ì„¤ëª…\` í˜•ì‹ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`);
              codeQualityScore -= 5;
            }
            
            if (!pr.body || pr.body.length < 50) {
              reviewComments.push(`ğŸ“„ **PR ì„¤ëª…**: PR ì„¤ëª…ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ë³€ê²½ì‚¬í•­ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
              codeQualityScore -= 5;
            }
            
            // ë¸Œëœì¹˜ëª… ì²´í¬
            const branchName = pr.head.ref;
            if (!branchName.match(/^(feature|fix|hotfix|release)\/[a-z0-9-]+$/)) {
              reviewComments.push(`ğŸŒ¿ **ë¸Œëœì¹˜ëª…**: \`${branchName}\`ì´ ë„¤ì´ë° ì»¨ë²¤ì…˜ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. \`feature/ê¸°ëŠ¥ëª…\` í˜•ì‹ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`);
              codeQualityScore -= 3;
            }
            
            // ì½”ë“œ í’ˆì§ˆ ë“±ê¸‰ ê²°ì •
            let qualityGrade;
            if (codeQualityScore >= 90) qualityGrade = "ğŸ† ìš°ìˆ˜";
            else if (codeQualityScore >= 80) qualityGrade = "âœ… ì–‘í˜¸";
            else if (codeQualityScore >= 70) qualityGrade = "âš ï¸ ë³´í†µ";
            else qualityGrade = "âŒ ê°œì„ í•„ìš”";
            
            // ìë™ ë¦¬ë·° ëŒ“ê¸€ ìƒì„±
            const reviewComment = `## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·° ê²°ê³¼

            **ğŸ“Š ì½”ë“œ í’ˆì§ˆ ì ìˆ˜: ${codeQualityScore}/100 (${qualityGrade})**

            ### ğŸ“‹ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [${pr.title.match(/^\[(feat|fix|docs|style|refactor|test|chore)\]/) ? 'x' : ' '}] PR ì œëª© ì»¨ë²¤ì…˜ ì¤€ìˆ˜
            - [${pr.body && pr.body.length >= 50 ? 'x' : ' '}] ì¶©ë¶„í•œ PR ì„¤ëª…
            - [${branchName.match(/^(feature|fix|hotfix|release)\/[a-z0-9-]+$/) ? 'x' : ' '}] ë¸Œëœì¹˜ëª… ì»¨ë²¤ì…˜ ì¤€ìˆ˜
            - [${pythonFiles.every(f => f.changes <= 300) ? 'x' : ' '}] ì ì ˆí•œ íŒŒì¼ í¬ê¸°
            - [${files.data.some(f => f.filename.includes('test_')) ? 'x' : ' '}] í…ŒìŠ¤íŠ¸ ì½”ë“œ í¬í•¨

            ### ğŸ” ë°œê²¬ëœ ì´ìŠˆë“¤
            ${reviewComments.length > 0 ? reviewComments.map(comment => `- ${comment}`).join('\n') : '- âœ… ë°œê²¬ëœ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤!'}

            ### ğŸ“ˆ ê°œì„  ì œì•ˆ
            ${codeQualityScore < 90 ? `
            - ì½”ë“œ í’ˆì§ˆ í–¥ìƒì„ ìœ„í•´ ë‹¤ìŒ ì‚¬í•­ë“¤ì„ í™•ì¸í•´ë³´ì„¸ìš”:
              - íŒŒì¼ í¬ê¸°ë¥¼ ì ì ˆíˆ ìœ ì§€ (300ì¤„ ì´í•˜ ê¶Œì¥)
              - í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± ë° ì»¤ë²„ë¦¬ì§€ í™•ë³´
              - ë„¤ì´ë° ì»¨ë²¤ì…˜ ì¤€ìˆ˜
              - ì¶©ë¶„í•œ ë¬¸ì„œí™”
            ` : '- ğŸ‰ ì½”ë“œ í’ˆì§ˆì´ ìš°ìˆ˜í•©ë‹ˆë‹¤!'}

            ### ğŸ›¡ï¸ ë³´ì•ˆ ì²´í¬
            - Python íŒŒì¼ ìˆ˜: ${pythonFiles.length}ê°œ
            - ë³€ê²½ í†µê³„: +${files.data.reduce((sum, f) => sum + f.additions, 0)} / -${files.data.reduce((sum, f) => sum + f.deletions, 0)}

            ### ğŸ“š ì°¸ê³  ìë£Œ
            - [ì½”ë”© ì»¨ë²¤ì…˜ ê°€ì´ë“œ](https://github.com/your-org/coding-conventions)
            - [í…ŒìŠ¤íŠ¸ ì‘ì„± ê°€ì´ë“œ](https://github.com/your-org/testing-guide)
            - [ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸](https://github.com/your-org/security-checklist)

            ---
            *ì´ ë¦¬ë·°ëŠ” GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ ìˆ˜ë™ ë¦¬ë·°ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.*`;
            
            // ë¦¬ë·° ëŒ“ê¸€ ì‘ì„±
            await github.rest.issues.createComment({
              issue_number: pr.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewComment
            });
            
            // ì½”ë“œ í’ˆì§ˆì´ ë‚®ìœ¼ë©´ ë¦¬ë·° ìš”ì²­
            if (codeQualityScore < 70) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                event: 'REQUEST_CHANGES',
                body: `ì½”ë“œ í’ˆì§ˆ ì ìˆ˜ê°€ ${codeQualityScore}ì ìœ¼ë¡œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. ìœ„ì˜ ìë™ ë¦¬ë·° ê²°ê³¼ë¥¼ ì°¸ê³ í•˜ì—¬ ìˆ˜ì •í•´ì£¼ì„¸ìš”.`
              });
            } else if (codeQualityScore >= 90) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                event: 'APPROVE',
                body: `ìë™ ë¦¬ë·° ê²°ê³¼ ì½”ë“œ í’ˆì§ˆì´ ìš°ìˆ˜í•©ë‹ˆë‹¤! ğŸ‰`
              });
            }
            
          } catch (error) {
            console.error('Error in code review:', error);
            
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë¦¬ë·° ëŒ“ê¸€
            await github.rest.issues.createComment({
              issue_number: pr.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âš ï¸ ìë™ ì½”ë“œ ë¦¬ë·° ì˜¤ë¥˜
              
              ìë™ ì½”ë“œ ë¦¬ë·° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ë¦¬ë·°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.
              
              **ì˜¤ë¥˜ ì •ë³´:** ${error.message}
              
              ---
              *ìˆ˜ë™ ë¦¬ë·°ì–´ì˜ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.*`
            });
          } 