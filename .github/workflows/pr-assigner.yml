name: PR Auto Assigner

on:
  pull_request:
    types: [opened, reopened]

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Auto assign PR
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const author = pr.user.login;
          
          // íŒ€ ë©¤ë²„ ì •ì˜ (ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
          const teamMembers = [
            'team-leader',
            'senior-dev-1', 
            'senior-dev-2',
            'backend-dev',
            'frontend-dev'
          ];
          
          // ì½”ë“œ ì†Œìœ ì ë§¤í•‘ (íŒŒì¼ ê²½ë¡œ ê¸°ë°˜)
          const codeOwners = {
            'backend/': ['backend-dev', 'senior-dev-1'],
            'frontend/': ['frontend-dev', 'senior-dev-2'],
            'docs/': ['team-leader'],
            'tests/': ['backend-dev', 'frontend-dev'],
            '.github/': ['team-leader', 'senior-dev-1']
          };
          
          let assignees = [];
          let reviewers = [];
          
          try {
            // PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            // ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œ ë¶„ì„
            const changedPaths = files.data.map(file => file.filename);
            const relevantOwners = new Set();
            
            // ê° íŒŒì¼ ê²½ë¡œì— ëŒ€í•´ ì½”ë“œ ì†Œìœ ì ì°¾ê¸°
            changedPaths.forEach(path => {
              Object.keys(codeOwners).forEach(pattern => {
                if (path.startsWith(pattern)) {
                  codeOwners[pattern].forEach(owner => relevantOwners.add(owner));
                }
              });
            });
            
            // ì‘ì„±ìë¥¼ ì œì™¸í•œ ê´€ë ¨ ì†Œìœ ìë“¤ì„ ë¦¬ë·°ì–´ë¡œ í• ë‹¹
            reviewers = Array.from(relevantOwners).filter(owner => owner !== author);
            
            // ë¦¬ë·°ì–´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ íŒ€ ë¦¬ë” í• ë‹¹
            if (reviewers.length === 0) {
              reviewers = ['team-leader'];
            }
            
            // ìµœëŒ€ 3ëª…ì˜ ë¦¬ë·°ì–´ë§Œ í• ë‹¹
            reviewers = reviewers.slice(0, 3);
            
            // PR ì‘ì„±ìë¥¼ assigneeë¡œ í• ë‹¹
            assignees = [author];
            
          } catch (error) {
            console.log('Error analyzing files, using default assignment');
            // ê¸°ë³¸ê°’ìœ¼ë¡œ íŒ€ ë¦¬ë”ë¥¼ ë¦¬ë·°ì–´ë¡œ í• ë‹¹
            reviewers = ['team-leader'];
            assignees = [author];
          }
          
          // Assignees í• ë‹¹
          if (assignees.length > 0) {
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                assignees: assignees
              });
              console.log(`Assigned PR to: ${assignees.join(', ')}`);
            } catch (error) {
              console.log(`Failed to assign PR: ${error.message}`);
            }
          }
          
          // Reviewers í• ë‹¹
          if (reviewers.length > 0) {
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                reviewers: reviewers
              });
              console.log(`Requested reviews from: ${reviewers.join(', ')}`);
            } catch (error) {
              console.log(`Failed to request reviews: ${error.message}`);
            }
          }
          
          // í• ë‹¹ ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
          const assignmentComment = `## ğŸ”„ ìë™ í• ë‹¹ ì™„ë£Œ

          **ğŸ‘¥ í• ë‹¹ëœ ë‹´ë‹¹ì:**
          ${assignees.map(a => `- @${a}`).join('\n')}

          **ğŸ‘¨â€ğŸ’» ìš”ì²­ëœ ë¦¬ë·°ì–´:**
          ${reviewers.map(r => `- @${r}`).join('\n')}

          **ğŸ“ í• ë‹¹ ê¸°ì¤€:**
          - ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê´€ë ¨ ì½”ë“œ ì†Œìœ ìì—ê²Œ ë¦¬ë·° ìš”ì²­
          - PR ì‘ì„±ìë¥¼ ë‹´ë‹¹ìë¡œ ìë™ í• ë‹¹

          ---
          *ì´ í• ë‹¹ì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.*`;
          
          await github.rest.issues.createComment({
            issue_number: pr.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: assignmentComment
          }); 