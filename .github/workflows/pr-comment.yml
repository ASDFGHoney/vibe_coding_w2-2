name: PR Comment

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  pr-comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Generate PR comment
      id: pr-info
      run: |
        PR_NUMBER="${{ github.event.pull_request.number }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
        BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
        
        # íŒŒì¼ ë³€ê²½ í†µê³„ ìƒì„±
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | wc -l)
        
        # ëŒ“ê¸€ ë‚´ìš© ìƒì„±
        COMMENT="## ğŸ‰ ìƒˆë¡œìš´ Pull Requestê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!

        **ğŸ“‹ PR ì •ë³´:**
        - **ë²ˆí˜¸:** #$PR_NUMBER
        - **ì œëª©:** $PR_TITLE
        - **ì‘ì„±ì:** @$PR_AUTHOR
        - **ë¸Œëœì¹˜:** \`$BRANCH_NAME\` â†’ \`$BASE_BRANCH\`
        - **ë³€ê²½ëœ íŒŒì¼ ìˆ˜:** $CHANGED_FILESê°œ

        **âœ… ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸:**
        - [ ] ì½”ë“œ í’ˆì§ˆ ë° ìŠ¤íƒ€ì¼ í™•ì¸
        - [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± ì—¬ë¶€ í™•ì¸
        - [ ] ë³´ì•ˆ ì·¨ì•½ì  ê²€í† 
        - [ ] ì„±ëŠ¥ ì˜í–¥ë„ ê²€í† 
        - [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ í•„ìš”ì„± í™•ì¸

        **ğŸ¤– ìë™í™” ìƒíƒœ:**
        - í…ŒìŠ¤íŠ¸ ì‹¤í–‰: ì§„í–‰ ì¤‘...
        - ì½”ë“œ ì»¤ë²„ë¦¬ì§€: ë¶„ì„ ì¤‘...
        - ë³´ì•ˆ ìŠ¤ìº”: ì˜ˆì •ë¨

        ---
        *ì´ ëŒ“ê¸€ì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*"
        
        echo "comment<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create PR comment
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${{ steps.pr-info.outputs.comment }}`
          })

  pr-update-comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    if: github.event.action == 'synchronize'
    
    steps:
    - name: Update PR comment on push
      uses: actions/github-script@v7
      with:
        script: |
          const updateComment = `## ğŸ”„ PRì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!

          **ğŸ“… ì—…ë°ì´íŠ¸ ì‹œê°„:** ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}
          **ğŸ”¨ ì»¤ë°‹ SHA:** \`${{ github.event.pull_request.head.sha }}\`

          **ğŸ” ìƒˆë¡œìš´ ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤:**
          - ìë™ í…ŒìŠ¤íŠ¸ê°€ ë‹¤ì‹œ ì‹¤í–‰ë©ë‹ˆë‹¤
          - ì½”ë“œ ë¦¬ë·°ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”
          - ìƒˆë¡œìš´ ë³€ê²½ì‚¬í•­ì— ëŒ€í•œ ì¶”ê°€ ê²€í† ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

          ---
          *ì´ ëŒ“ê¸€ì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: updateComment
          }) 