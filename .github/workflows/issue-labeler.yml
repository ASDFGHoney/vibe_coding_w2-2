name: Issue Auto Labeler

on:
  issues:
    types: [opened, reopened, edited]

jobs:
  label-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
    - name: Auto label issue
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          const title = issue.title.toLowerCase();
          const body = (issue.body || '').toLowerCase();
          const author = issue.user.login;
          
          let labels = [];
          
          try {
            // 1. ì œëª© ê¸°ë°˜ ë¼ë²¨ë§
            if (title.includes('[bug]') || title.includes('bug') || title.includes('error') || title.includes('broken')) {
              labels.push('bug');
            }
            if (title.includes('[feature]') || title.includes('feature') || title.includes('add') || title.includes('new')) {
              labels.push('feature');
            }
            if (title.includes('[question]') || title.includes('question') || title.includes('how to') || title.includes('help')) {
              labels.push('question');
            }
            if (title.includes('[enhancement]') || title.includes('enhancement') || title.includes('improve') || title.includes('better')) {
              labels.push('enhancement');
            }
            if (title.includes('[docs]') || title.includes('documentation') || title.includes('readme')) {
              labels.push('documentation');
            }
            if (title.includes('urgent') || title.includes('critical') || title.includes('asap')) {
              labels.push('urgent');
            }
            
            // 2. ë‚´ìš© ê¸°ë°˜ ë¼ë²¨ë§
            const allText = title + ' ' + body;
            
            // ê¸°ìˆ  ìŠ¤íƒ ê´€ë ¨
            if (allText.includes('backend') || allText.includes('api') || allText.includes('server') || allText.includes('fastapi')) {
              labels.push('backend');
            }
            if (allText.includes('frontend') || allText.includes('ui') || allText.includes('client') || allText.includes('streamlit')) {
              labels.push('frontend');
            }
            if (allText.includes('database') || allText.includes('sql') || allText.includes('db')) {
              labels.push('database');
            }
            if (allText.includes('test') || allText.includes('testing') || allText.includes('pytest')) {
              labels.push('testing');
            }
            if (allText.includes('deploy') || allText.includes('deployment') || allText.includes('docker') || allText.includes('ci/cd')) {
              labels.push('deployment');
            }
            if (allText.includes('security') || allText.includes('auth') || allText.includes('permission') || allText.includes('vulnerability')) {
              labels.push('security');
            }
            if (allText.includes('performance') || allText.includes('slow') || allText.includes('optimization')) {
              labels.push('performance');
            }
            
            // 3. ìš°ì„ ìˆœìœ„ íŒë‹¨
            const highPriorityKeywords = ['critical', 'urgent', 'blocking', 'production', 'down', 'broken'];
            const mediumPriorityKeywords = ['important', 'needed', 'asap'];
            const lowPriorityKeywords = ['nice to have', 'future', 'maybe', 'consider'];
            
            if (highPriorityKeywords.some(keyword => allText.includes(keyword))) {
              labels.push('priority: high');
            } else if (mediumPriorityKeywords.some(keyword => allText.includes(keyword))) {
              labels.push('priority: medium');
            } else if (lowPriorityKeywords.some(keyword => allText.includes(keyword))) {
              labels.push('priority: low');
            } else {
              // ê¸°ë³¸ ìš°ì„ ìˆœìœ„ëŠ” ë²„ê·¸ë©´ high, ê¸°ëŠ¥ì´ë©´ medium
              if (labels.includes('bug')) {
                labels.push('priority: high');
              } else if (labels.includes('feature')) {
                labels.push('priority: medium');
              }
            }
            
            // 4. ë‚œì´ë„ íŒë‹¨
            if (allText.includes('beginner') || allText.includes('easy') || allText.includes('simple')) {
              labels.push('good-first-issue');
            }
            if (allText.includes('help') || allText.includes('assistance') || allText.includes('contribute')) {
              labels.push('help-wanted');
            }
            
            // 5. ìƒíƒœ ê´€ë ¨
            if (allText.includes('duplicate') || allText.includes('same as')) {
              labels.push('duplicate');
            }
            if (allText.includes('invalid') || allText.includes('not reproducible')) {
              labels.push('invalid');
            }
            
            // 6. íŠ¹ë³„í•œ ì¼€ì´ìŠ¤ë“¤
            if (allText.includes('breaking change') || allText.includes('breaking-change')) {
              labels.push('breaking-change');
            }
            if (allText.includes('accessibility') || allText.includes('a11y')) {
              labels.push('accessibility');
            }
            if (allText.includes('mobile') || allText.includes('responsive')) {
              labels.push('mobile');
            }
            
            // 7. ì‘ì„±ì ê¸°ë°˜ ë¼ë²¨ë§
            // ìƒˆë¡œìš´ ê¸°ì—¬ìì¸ì§€ í™•ì¸ (ì‹¤ì œë¡œëŠ” GitHub APIë¡œ í™•ì¸í•´ì•¼ í•¨)
            const isNewContributor = false; // ì´ ë¶€ë¶„ì€ ì‹¤ì œ êµ¬í˜„ì—ì„œ APIë¡œ í™•ì¸
            if (isNewContributor) {
              labels.push('new-contributor');
            }
            
            // 8. ì´ìŠˆ ê¸¸ì´ ê¸°ë°˜ íŒë‹¨
            if (body.length < 50) {
              labels.push('needs-more-info');
            }
            
            // 9. í…œí”Œë¦¿ ì‚¬ìš© ì—¬ë¶€ í™•ì¸
            const hasTemplate = body.includes('## ì„¤ëª…') || body.includes('## Description') || 
                               body.includes('## ì¬í˜„ ë°©ë²•') || body.includes('## Steps to reproduce');
            if (!hasTemplate && labels.includes('bug')) {
              labels.push('needs-template');
            }
            
            // ì¤‘ë³µ ì œê±°
            labels = [...new Set(labels)];
            
            // ìµœì†Œ í•˜ë‚˜ì˜ ë¼ë²¨ì€ ìˆì–´ì•¼ í•¨
            if (labels.length === 0) {
              labels.push('triage');
            }
            
            // ë¼ë²¨ ì ìš©
            if (labels.length > 0) {
              await github.rest.issues.setLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
              
              console.log(`Applied labels: ${labels.join(', ')}`);
              
              // ë¼ë²¨ë§ ë¶„ì„ ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
              const priorityLabels = labels.filter(label => label.startsWith('priority:'));
              const typeLabels = labels.filter(label => ['bug', 'feature', 'question', 'enhancement', 'documentation'].includes(label));
              const techLabels = labels.filter(label => ['backend', 'frontend', 'database', 'testing', 'deployment', 'security', 'performance'].includes(label));
              const statusLabels = labels.filter(label => ['urgent', 'help-wanted', 'good-first-issue', 'needs-more-info', 'needs-template'].includes(label));
              
              const labelingComment = `## ğŸ·ï¸ ìë™ ë¼ë²¨ë§ ì™„ë£Œ

              **ğŸ“Š ì ìš©ëœ ë¼ë²¨ (ì´ ${labels.length}ê°œ):**
              ${labels.map(label => `- \`${label}\``).join('\n')}

              **ğŸ“‹ ë¼ë²¨ ë¶„ë¥˜:**
              ${typeLabels.length > 0 ? `- **íƒ€ì…**: ${typeLabels.join(', ')}` : ''}
              ${priorityLabels.length > 0 ? `- **ìš°ì„ ìˆœìœ„**: ${priorityLabels.join(', ')}` : ''}
              ${techLabels.length > 0 ? `- **ê¸°ìˆ  ìŠ¤íƒ**: ${techLabels.join(', ')}` : ''}
              ${statusLabels.length > 0 ? `- **ìƒíƒœ**: ${statusLabels.join(', ')}` : ''}

              **ğŸ” ë¼ë²¨ë§ ê¸°ì¤€:**
              - ì´ìŠˆ ì œëª© í‚¤ì›Œë“œ ë¶„ì„
              - ì´ìŠˆ ë‚´ìš© ê¸°ìˆ  ìŠ¤íƒ ê°ì§€
              - ìš°ì„ ìˆœìœ„ í‚¤ì›Œë“œ ë§¤ì¹­
              - í…œí”Œë¦¿ ì‚¬ìš© ì—¬ë¶€ í™•ì¸
              - ì´ìŠˆ í’ˆì§ˆ í‰ê°€

              **ğŸ“ ë‹¤ìŒ ë‹¨ê³„:**
              ${labels.includes('needs-more-info') ? '- âš ï¸ ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë” ìì„¸í•œ ì„¤ëª…ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\n' : ''}
              ${labels.includes('needs-template') ? '- âš ï¸ ì´ìŠˆ í…œí”Œë¦¿ ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.\n' : ''}
              ${labels.includes('triage') ? '- ğŸ” íŒ€ì—ì„œ ì´ìŠˆë¥¼ ê²€í† í•˜ê³  ì ì ˆí•œ ë¼ë²¨ì„ ì¶”ê°€í•  ì˜ˆì •ì…ë‹ˆë‹¤.\n' : ''}
              ${labels.includes('urgent') ? '- ğŸš¨ ê¸´ê¸‰ ì´ìŠˆë¡œ ë¶„ë¥˜ë˜ì–´ ìš°ì„  ì²˜ë¦¬ë  ì˜ˆì •ì…ë‹ˆë‹¤.\n' : ''}
              ${labels.includes('good-first-issue') ? '- ğŸŒŸ ì²« ê¸°ì—¬ì— ì í•©í•œ ì´ìŠˆì…ë‹ˆë‹¤. ë§ì€ ì°¸ì—¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤!\n' : ''}

              **â° ì˜ˆìƒ ì²˜ë¦¬ ì‹œê°„:**
              ${priorityLabels.includes('priority: high') ? '- 1-2ì¼ ë‚´ ì´ˆê¸° ëŒ€ì‘' : 
                priorityLabels.includes('priority: medium') ? '- 3-5ì¼ ë‚´ ì´ˆê¸° ëŒ€ì‘' : 
                priorityLabels.includes('priority: low') ? '- 1-2ì£¼ ë‚´ ì´ˆê¸° ëŒ€ì‘' : 
                '- íŒ€ ê²€í†  í›„ ì¼ì • ì•ˆë‚´'}

              ---
              *ì´ ë¼ë²¨ë§ì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ë¶€ì •í™•í•œ ë¼ë²¨ì´ ìˆë‹¤ë©´ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.*`;
              
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: labelingComment
              });
            }
            
          } catch (error) {
            console.error('Error in auto-labeling:', error);
            
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë¼ë²¨ ì ìš©
            const fallbackLabels = ['triage'];
            await github.rest.issues.setLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: fallbackLabels
            });
            
            await github.rest.issues.createComment({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âš ï¸ ìë™ ë¼ë²¨ë§ ì˜¤ë¥˜

              ìë™ ë¼ë²¨ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ \`triage\` ë¼ë²¨ì´ ì„ì‹œë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.

              **ì˜¤ë¥˜ ì •ë³´:** ${error.message}

              íŒ€ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì ì ˆí•œ ë¼ë²¨ì„ ì ìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤.

              ---
              *ì˜¤ë¥˜ ë°œìƒìœ¼ë¡œ ì¸í•œ ì„ì‹œ ë¼ë²¨ë§ì…ë‹ˆë‹¤.*`
            });
          } 